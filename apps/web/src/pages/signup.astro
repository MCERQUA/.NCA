---
export const prerender = true;

---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '../components/ui/Card';
---

<BaseLayout
  title="Contractor Signup - National Contractor Association"
  description="Create your contractor profile and start connecting with customers today."
>
  <Header />
  <main class="min-h-screen bg-gray-50 py-12 px-4">
    <div class="container mx-auto max-w-4xl">
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-heading font-bold text-charcoal mb-4">
          Create Your Contractor Profile
        </h1>
        <p class="text-xl text-slate max-w-2xl mx-auto">
          Join our network and start appearing on the map. Fill out the form below to create your profile.
        </p>
      </div>

      <!-- Success Message (hidden by default) -->
      <div id="success-message" class="hidden mb-8">
        <Card className="border-green-500 bg-green-50">
          <CardContent className="p-6">
            <div class="flex items-start">
              <svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <div>
                <h3 class="text-lg font-semibold text-green-900 mb-1">Application Submitted Successfully!</h3>
                <p class="text-green-800">Thank you for submitting your contractor profile. Our team will review your application and activate your profile within 24 hours. You'll receive an email once approved.</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      <!-- Error Message (hidden by default) -->
      <div id="error-message" class="hidden mb-8">
        <Card className="border-red-500 bg-red-50">
          <CardContent className="p-6">
            <div class="flex items-start">
              <svg class="w-6 h-6 text-red-500 mr-3 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <div>
                <h3 class="text-lg font-semibold text-red-900 mb-1">Error Creating Profile</h3>
                <p id="error-text" class="text-red-800"></p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      <!-- Signup Form -->
      <Card>
        <CardHeader>
          <CardTitle>Contractor Information</CardTitle>
          <CardDescription>Fill out all required fields to create your profile</CardDescription>
        </CardHeader>
        <CardContent className="p-8">
          <form
            id="signup-form"
            class="space-y-6"
          >
            <!-- Business Information -->
            <div class="space-y-4">
              <h3 class="text-lg font-semibold text-charcoal">Business Information</h3>

              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                    Contact Name <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="name"
                    name="name"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="John Smith"
                  />
                </div>

                <div>
                  <label for="businessName" class="block text-sm font-medium text-gray-700 mb-2">
                    Business Name
                  </label>
                  <input
                    type="text"
                    id="businessName"
                    name="businessName"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="Smith Roofing LLC"
                  />
                  <p class="text-xs text-gray-500 mt-1">Leave blank to use contact name</p>
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                    Primary Service Category <span class="text-red-500">*</span>
                  </label>
                  <select
                    id="category"
                    name="category"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                  >
                    <option value="">Select a category...</option>
                    <option value="Insulation">Insulation</option>
                    <option value="Roofing">Roofing</option>
                    <option value="Electrical">Electrical</option>
                    <option value="Plumbing">Plumbing</option>
                    <option value="HVAC">HVAC</option>
                    <option value="Painting">Painting</option>
                    <option value="Remodeling">Remodeling</option>
                    <option value="Landscaping">Landscaping</option>
                    <option value="Flooring">Flooring</option>
                    <option value="General Contractor">General Contractor</option>
                    <option value="Windows & Doors">Windows & Doors</option>
                    <option value="Foundation">Foundation</option>
                    <option value="Concrete">Concrete</option>
                    <option value="Masonry">Masonry</option>
                    <option value="Carpentry">Carpentry</option>
                    <option value="Other">Other</option>
                  </select>
                </div>

                <div>
                  <label for="specialties" class="block text-sm font-medium text-gray-700 mb-2">
                    Specialties
                  </label>
                  <input
                    type="text"
                    id="specialties"
                    name="specialties"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="Shingle Roofing, Flat Roofs"
                  />
                  <p class="text-xs text-gray-500 mt-1">Separate with commas</p>
                </div>
              </div>

              <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                  Business Description <span class="text-red-500">*</span>
                </label>
                <textarea
                  id="description"
                  name="description"
                  required
                  rows="4"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary resize-none"
                  placeholder="Describe your business, services, and what makes you stand out..."
                ></textarea>
              </div>
            </div>

            <!-- Location Information -->
            <div class="space-y-4 pt-6 border-t">
              <h3 class="text-lg font-semibold text-charcoal">Location</h3>

              <div>
                <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
                  Street Address
                </label>
                <input
                  type="text"
                  id="address"
                  name="address"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                  placeholder="123 Main Street"
                />
              </div>

              <div class="grid md:grid-cols-3 gap-4">
                <div>
                  <label for="city" class="block text-sm font-medium text-gray-700 mb-2">
                    City <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="city"
                    name="city"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="Los Angeles"
                  />
                </div>

                <div>
                  <label for="state" class="block text-sm font-medium text-gray-700 mb-2">
                    State <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="state"
                    name="state"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="CA"
                    maxlength="2"
                  />
                </div>

                <div>
                  <label for="zipCode" class="block text-sm font-medium text-gray-700 mb-2">
                    ZIP Code
                  </label>
                  <input
                    type="text"
                    id="zipCode"
                    name="zipCode"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="90001"
                  />
                </div>
              </div>
            </div>

            <!-- Contact Information -->
            <div class="space-y-4 pt-6 border-t">
              <h3 class="text-lg font-semibold text-charcoal">Contact Information</h3>

              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                    Phone Number <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="tel"
                    id="phone"
                    name="phone"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="844-967-5247"
                  />
                </div>

                <div>
                  <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                    Email Address <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="josh@contractorschoiceagency.com"
                  />
                </div>
              </div>

              <div>
                <label for="website" class="block text-sm font-medium text-gray-700 mb-2">
                  Website
                </label>
                <input
                  type="url"
                  id="website"
                  name="website"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                  placeholder="https://example.com"
                />
              </div>
            </div>

            <!-- Additional Information -->
            <div class="space-y-4 pt-6 border-t">
              <h3 class="text-lg font-semibold text-charcoal">Additional Information</h3>

              <div class="grid md:grid-cols-3 gap-4">
                <div>
                  <label for="licenseNumber" class="block text-sm font-medium text-gray-700 mb-2">
                    License Number
                  </label>
                  <input
                    type="text"
                    id="licenseNumber"
                    name="licenseNumber"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="LIC#123456"
                  />
                </div>

                <div>
                  <label for="yearsInBusiness" class="block text-sm font-medium text-gray-700 mb-2">
                    Years in Business
                  </label>
                  <input
                    type="number"
                    id="yearsInBusiness"
                    name="yearsInBusiness"
                    min="0"
                    max="100"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="10"
                  />
                </div>

                <div>
                  <label for="employeeCount" class="block text-sm font-medium text-gray-700 mb-2">
                    Number of Employees
                  </label>
                  <input
                    type="number"
                    id="employeeCount"
                    name="employeeCount"
                    min="1"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="5"
                  />
                </div>
              </div>
            </div>

            <!-- Company Images -->
            <div class="space-y-4 pt-6 border-t">
              <h3 class="text-lg font-semibold text-charcoal">Company Images</h3>
              <p class="text-sm text-gray-600">Upload your company logo and profile image to enhance your listing</p>

              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label for="logo" class="block text-sm font-medium text-gray-700 mb-2">
                    Company Logo
                  </label>
                  <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-primary transition-colors">
                    <input
                      type="file"
                      id="logo"
                      name="logo"
                      accept="image/jpeg,image/jpg,image/png,image/webp"
                      class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                    />
                    <div class="text-center">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                      </svg>
                      <p class="mt-2 text-sm text-gray-600">Click to upload logo</p>
                      <p class="text-xs text-gray-500 mt-1">PNG, JPG, WebP (max 5MB)</p>
                    </div>
                    <div id="logo-preview" class="hidden mt-3">
                      <p class="text-sm font-medium text-green-600 text-center"></p>
                    </div>
                  </div>
                </div>

                <div>
                  <label for="profileImage" class="block text-sm font-medium text-gray-700 mb-2">
                    Profile/Cover Image
                  </label>
                  <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-primary transition-colors">
                    <input
                      type="file"
                      id="profileImage"
                      name="profileImage"
                      accept="image/jpeg,image/jpg,image/png,image/webp"
                      class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                    />
                    <div class="text-center">
                      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                      </svg>
                      <p class="mt-2 text-sm text-gray-600">Click to upload image</p>
                      <p class="text-xs text-gray-500 mt-1">PNG, JPG, WebP (max 5MB)</p>
                    </div>
                    <div id="image-preview" class="hidden mt-3">
                      <p class="text-sm font-medium text-green-600 text-center"></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="pt-6">
              <button
                id="submit-btn"
                type="submit"
                class="w-full bg-primary text-white font-semibold py-4 px-6 rounded-lg hover:bg-primary-600 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
              >
                Submit Application
              </button>
              <p class="text-sm text-gray-500 text-center mt-3">
                We'll review your application and activate your profile within 24 hours
              </p>
            </div>
          </form>

          <script>
            // File preview handlers
            const logoInput = document.getElementById('logo') as HTMLInputElement;
            const profileImageInput = document.getElementById('profileImage') as HTMLInputElement;
            const logoPreview = document.getElementById('logo-preview');
            const imagePreview = document.getElementById('image-preview');

            logoInput?.addEventListener('change', (e) => {
              const file = (e.target as HTMLInputElement).files?.[0];
              if (file && logoPreview) {
                logoPreview.classList.remove('hidden');
                logoPreview.querySelector('p')!.textContent = `✓ ${file.name}`;
              }
            });

            profileImageInput?.addEventListener('change', (e) => {
              const file = (e.target as HTMLInputElement).files?.[0];
              if (file && imagePreview) {
                imagePreview.classList.remove('hidden');
                imagePreview.querySelector('p')!.textContent = `✓ ${file.name}`;
              }
            });

            // Form submission handler
            document.getElementById('signup-form')?.addEventListener('submit', async (e) => {
              e.preventDefault();

              const form = e.target as HTMLFormElement;
              const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
              const successMessage = document.getElementById('success-message');
              const errorMessage = document.getElementById('error-message');
              const errorText = document.getElementById('error-text');

              // Hide messages
              successMessage?.classList.add('hidden');
              errorMessage?.classList.add('hidden');

              // Disable submit button
              submitBtn.disabled = true;
              submitBtn.textContent = 'Uploading images...';

              try {
                const formData = new FormData(form);

                // Generate a slug for the contractor from business name or name
                const businessName = formData.get('businessName') as string;
                const name = formData.get('name') as string;
                const contractorSlug = (businessName || name)
                  .toLowerCase()
                  .replace(/[^a-z0-9]+/g, '-')
                  .replace(/^-|-$/g, '');

                // Upload logo if present
                const logoFile = formData.get('logo') as File;
                let logoUrl = '';
                if (logoFile && logoFile.size > 0) {
                  submitBtn.textContent = 'Uploading logo...';
                  const logoFormData = new FormData();
                  logoFormData.append('file', logoFile);
                  logoFormData.append('type', 'logo');
                  logoFormData.append('contractorSlug', contractorSlug);

                  const logoResponse = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: logoFormData,
                  });

                  if (logoResponse.ok) {
                    const logoResult = await logoResponse.json();
                    logoUrl = logoResult.url;
                  } else {
                    const logoError = await logoResponse.json();
                    throw new Error(`Logo upload failed: ${logoError.error}`);
                  }
                }

                // Upload profile image if present
                const imageFile = formData.get('profileImage') as File;
                let imageUrl = '';
                if (imageFile && imageFile.size > 0) {
                  submitBtn.textContent = 'Uploading profile image...';
                  const imageFormData = new FormData();
                  imageFormData.append('file', imageFile);
                  imageFormData.append('type', 'image');
                  imageFormData.append('contractorSlug', contractorSlug);

                  const imageResponse = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: imageFormData,
                  });

                  if (imageResponse.ok) {
                    const imageResult = await imageResponse.json();
                    imageUrl = imageResult.url;
                  } else {
                    const imageError = await imageResponse.json();
                    throw new Error(`Profile image upload failed: ${imageError.error}`);
                  }
                }

                // Add image URLs to form data
                if (logoUrl) formData.set('logoUrl', logoUrl);
                if (imageUrl) formData.set('imageUrl', imageUrl);

                // Remove file inputs from formData
                formData.delete('logo');
                formData.delete('profileImage');

                // Submit contractor data
                submitBtn.textContent = 'Creating profile...';
                const response = await fetch('/api/contractors', {
                  method: 'POST',
                  body: formData,
                });

                const result = await response.json();

                if (response.ok && result.success) {
                  successMessage?.classList.remove('hidden');
                  form.reset();
                  // Reset previews
                  logoPreview?.classList.add('hidden');
                  imagePreview?.classList.add('hidden');
                  window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                  throw new Error(result.error || 'Failed to submit application');
                }
              } catch (error) {
                errorMessage?.classList.remove('hidden');
                if (errorText) {
                  errorText.textContent = error instanceof Error ? error.message : 'An error occurred. Please try again.';
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
              } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Application';
              }
            });
          </script>
        </CardContent>
      </Card>
    </div>
  </main>
  <Footer />
</BaseLayout>
